<!DOCTYPE html>
<html>
  <head>
    <title>Ascension | Crossed Banners ~ Chronicle</title>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
    <meta content='width=device-width, initial-scale=1' name='viewport'/>
  </head>
  <body>

  <style>

.ui.text.container {
    max-width: 920px !important;
}

  .ui.form {
    font-size: 1rem;
    margin-bottom: 32px;
  }

  p {
    font-size: 1.2em;
    line-height: 1.6em;
    color: #555;
  }

  span.value,
  span.points,
  span.episode,
  span.power,
  span.house {
    color: black;
    font-weight: 500;
  }

  span.award,
  span.points {
    font-size: 1.5em;
    vertical-align: text-bottom;
    padding: 0 14px;
    display: inline-block;
  }

  span.episode {
    padding: 0 14px;
    display: inline-block;
    font-variant : small-caps;
    font-style: italic;
  }
  
  span.health,
  span.award,
  span.power {
    font-variant : titling-caps;
    color: rgba(19, 157, 255, 0.93)!important;
  }

  span.character,
  span.house {
    text-transform: uppercase;
    padding: 0 8px;
    display: inline-block;
  }

  span.pre {
    display: block;
    padding-bottom: 12px;
  }

  span.success {
    font-weight: bold;
    color: rgba(35, 224, 22, 0.93)!important
  }

  .ui.sortable.table thead th.sorted {
    background: white;
  }

  .modebar {
    display: none;
  }

  .card > .image {
    height: 14em;
    width: 100%;
  }

  .image-holder{
      height: 100%;
      width: 100%;
      background-size: cover;
      background-position: top center;
  }

  .ui.cards>.card>.content>.meta,
  .ui.cards>.card>.content>.header {
    color : white;
  }

  .ui.cards> .card> .extra.content {
    color : white;
  }

  .ui.cards > .card,
  .ui.card,
  .ui.cards > .card {
    box-shadow: none !important;
  }

  .sticky {
    background-color: white;
    padding: 12px !important;
  }

  h4.divider.header {
    margin-bottom: 24px !important;
  }

  </style>

    <div class="ui hidden failed negative message">
      <i class="close icon"></i>
      <div class="header">
        We're sorry - Login failed for some reason.
      </div>
        <p>Please contact m@type.hk for support.</p>
      </div>
      <!-- Sidebar Menu -->
      <div class="ui inverted vertical sidebar menu">
        <a href="index.html" class="item">Game</a>
        <a href="rules.html" class="item">Rules</a>
        <a href="chronicle.html" class="active item">Chronicle</a>   
        <a href="characters.html" class="item">Characters</a>
      </div>
      <!-- Page Contents -->
      <div class="pusher">
        <div class="ui vertical masthead center aligned segment">
          <div class="ui container">
            <div class="ui large secondary pointing menu">
              <a class="toc item">
                <i class="sidebar icon"></i>
              </a>
              <a href="game.html" class="item">Game</a>
              <a href="rules.html" class="item">Rules</a>
              <a href="chronicle.html" class="active item">Chronicle</a>
              <a href="characters.html" class="item">Characters</a>
            </div>
          </div>
        </div>
        <div class="ui text container">
          <form onsubmit="return false;" class="ui form voting">
            <div class="ui">
              <h2 style="text-align: center;">CHRONICLE</h2>
            </div>

            <h3 class="ui horizontal pink divider header sticky episodesx" style="overflow: visible;">
            <div class="ui inline dropdown episode">
              <div class="text">
                <i class="film icon"></i>
                Loading ... 
              </div>
              <i class="dropdown icon"></i>
              <div class="menu episodes"></div>
            </div>
            </h3>
            
            <h3 class="ui horizontal blue divider header optional sticky leaguesx" style="display: none; overflow: visible;">
            <div class="ui inline dropdown league">
              <div class="text">
                <i class="university icon"></i>
                Select League
              </div>
              <i class="dropdown icon"></i>
              <div class="menu leagues"></div>
            </div>
            </h3>

            <h4 class="ui horizontal divider header">
              <i class="columns icon"></i>
              Leaderboard
            </h4>

            <table id="leaderboard" class="ui very basic celled table left floated sortable">
          </table>

            <h4 class="ui horizontal divider header">
            <i class="spy icon"></i>
            Private Announcements
            </h4>

           
            <h3 class="ui top attached inverted blue header sub header"><i class="newspaper icon"></i>
              Diplomatic Intelligence
            </h3>
            <div id="diplomatic">
              <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
       
            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Assassination Reports
            </h3>
            <div id="assassination">
              <div class="ui attached segment">
                  <div class="ui piled segments">
                    <div class="ui center aligned segment">
                      <p class="nonews">No news today</p>
                    </div> 
                  </div> 
                </div>
            </div>
            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Roster Damage 
            </h3>
            <div id="target">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            <h3 class="ui top attached inverted olive header sub header"><i class="newspaper icon"></i>
              House Abilities
            </h3>
            <div id="ability">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            
            <h3 class="ui top attached inverted blue header sub header"><i class="newspaper icon"></i>
              Effective Torture Methods
            </h3>
            <div id="foiled">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            
            <h3 class="ui top attached inverted olive header sub header"><i class="newspaper icon"></i>
              Award Performance
            </h3>
            <div id="awards">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            <h3 class="ui top attached inverted olive header sub header"><i class="newspaper icon"></i>
              Rankings
            </h3>
            <div id="ranking">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
    
            <h4 class="ui horizontal divider header">
              <i class="announcement icon"></i>
              Public Announcements
            </h4>

            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Failed Assassination Attempts
            </h3>
            <div id="failed">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>

            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Health Reports
            </h3>
            <div id="damage">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment large">
                    <p class="nonews ui large">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>

            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Obituary
            </h3>
            <div id="death">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>           
            
            <h4 class="ui horizontal divider header">
              <i class="announcement icon"></i>
              League Voting Histogram
            </h4>
            <div id="vote-distribution">
              
            </div>

            <h4 class="ui horizontal divider header">
              <i class="announcement icon"></i>
              Your Votes
            </h4>
            <div id="player-votes" class="">
                <h2 id="voteCardsPlaceholder" class="ui center aligned icon header">
                No votes this episode.
                </h2>
                <div id="voteCards" class="ui three stackable cards">
                </div>
            </div>

            <h4 class="ui horizontal divider header">
              <i class="announcement icon"></i>
              Your Roster
            </h4>
            <div id="player-roster" class="">
                <h2 id="playerRosterPlaceholder" class="ui center aligned icon header">
                No Health Updates Yet.
                </h2>
                <div id="playerRoster" class="ui three stackable cards">
                </div>
            </div>

          </div>
        </div>

        <script src="semantic/dist/semantic.min.js"></script>
        <script src="bower_components/plotlyjs/plotly.min.js"></script>
        <script src="http://semantic-ui.com/javascript/library/tablesort.js"></script>

        
        <script>
        var db = new Firebase("https://ascension.firebaseio.com");

        var authData = db.getAuth();

        // Reusable Sets

        var numerals = [0, 'I', 'II', 'III', 'IV', 'V']
        var colors = {
            'bolton': 'red',
            'meereen': 'brown',
            'arryn': 'blue',
            'greyjoy': 'black',
            'martell': 'orange',
            'independent': 'pink',
            'nightswatch': 'grey',
            'minor': 'olive',
            'targaryen': 'purple',
            'tyrell': 'green',
            'lannister': 'yellow',
            'stark': 'grey'
        }
        
        // Semantic ui
        $('.ui.sidebar').sidebar('attach events', '.toc.item');
        $('.ui.accordion').accordion();

        // SET PLAYER 

        db.child('players').child(authData.uid).once('value', function(snapshot) {
            var player = snapshot.val();
            authData.house = player.house;
            authData.votes = Object.keys(player.votes);
            populateLeaguesDropdown(player.games);
            
            // SET EPISODE 

            db.child('episodes').once('value', function(snapshot) {
                var episodes = snapshot.val();
                populateEpisodeDropdown(episodes);
            });
        });


        // DISPLAY Player Chronicle Entries
        function msgTemplate(){
          html = ''
          html += '<div class="ui attached segment"><div class="ui piled center aligned segments"><div class="ui center aligned segment"><p class="nonews">'
          html += 'No news today'
          html += '</p></div></div></div>'
          return html
        }
        
        function addArticle(category, msg){
          $ref = $('#' + category)
          if (!$ref.hasClass('populated')){
            $ref.empty();
            $ref.addClass('populated')
          }
          html = ''
          html += '<div class="ui attached segment"><div class="ui piled segments"><div class="ui center aligned segment"><p>'
          html += msg
          html += '</p></div></div></div>'
          $ref.append(html)
        }

        function parsePlayerChronicles(entries){
          for (var entry in entries) {
            var a = entries[entry]
            addArticle(a.cat,a.msg)
            }
          }
        
        // GET Player Chronicle Entries

        function getPlayerChronicles(playerKey){
          db.child('player_chronicles').orderByKey()
            .equalTo(playerKey)
            .once('value', function(snapshot){
              parsePlayerChronicles(snapshot.val()[playerKey]['entries'])
            })
        }

        // DISPLAY Player Chronicle Entries

        function parsePublicChronicles(entries){
          for (var entry in entries) {
            var a = entries[entry]
            addArticle(a.cat,a.msg)
            }
          }

        // GET Public Chronicle Entries

        function getPublicChronicles(leagueKey){
          
            db.child('league_chronicles').orderByKey()
              .equalTo(leagueKey)
              .once('value', function(snapshot){
                try {
                  parsePublicChronicles(snapshot.val()[leagueKey]['entries'])
                } catch(e){
                  console.log('CHRONICLE NOT YET AVAILABLE.')
                }
              }, function (err) {
                console.log('CHRONICLE UNAVAILABLE.')
              })
            
        }

        // REFRESH Chroncles Entries
      
        function loadChronicleEntries(){
          var league = $('.ui.dropdown.league').dropdown("get value")
          var episode = $('.ui.dropdown.episode').dropdown("get value")
          var house = authData.house[league];

          $('.populated').empty()
          $('.populated').append(msgTemplate())
          $('.populated').removeClass('populated')

          getPlayerChronicles(league+house+episode);
          getPublicChronicles(league+episode);
          genetateLeaderboard(league, episode);
          generateVoteDistribution(league, episode);
          getPlayerVotes(league, episode);
        }

        // DISPLAY Leaderboard
        
        var scoretable;

        function genetateLeaderboard(league, episode){
          scoretable = []
          var template = '<thead><tr><th>Player Rank</th></tr></thead><tbody></tbody>'
          $('#leaderboard').empty().html(template) 
          db.child('players').once('value', function(snapshot){
            getLeaderBoard(league+episode, league, episode, snapshot.val())
          });
        }

        

        // GET Leaderboard
        function parseLeaderBoard(scores, league, episode, players){

          for (var score in scores['scores']){
            scoretable.push(
                {'id': score,'player': players[score], 'score' : parseInt(scores['scores'][score]), 'scores' : []}
              )
          }
          getEpisodeScores(league, episode);
        }

        function getLeaderBoard(leaderboardKey, league, episode, players){
          db.child('leaderboard').orderByKey()
            .equalTo(leaderboardKey)
            .once('value', function(snapshot){
              parseLeaderBoard(snapshot.val()[leaderboardKey], league, episode, players)
            })
        }

        // GET EpisodeScores

        function parseEpisodeScores(scores){
          for (var score in scores){
            $('#leaderboard > thead > tr').append("<th>" + scores[score]['episode'] + "</th>")
            var escores = scores[score]['scores']
            for (var player in escores){
                for (var i = 0; i < scoretable.length; i++) {
                  if (scoretable[i].id == player){
                    scoretable[i]['scores'].push(parseInt(escores[player]))
                  }
                }
            }
          }
          scoretable.sort(function(a,b) {return b.score - a.score}); 

          drawTable(scoretable);
        }


        function getEpisodeScores(league, episode){
          db.child('episode_scores').orderByKey()
            .startAt(league)
            .endAt(league+episode)
            .once('value', function(snapshot){
              parseEpisodeScores(snapshot.val())
            })
        }


        function drawTable(data) {


            for (var i = 0; i < data.length; i++) {
                drawRow(data[i], i);
            }
            $('#leaderboard > thead > tr').append("<th class='sorted descending'>Total</th>")

            $('.sortable.table').tablesort();

            $('.circular.label')
            .popup({
              inline   : true,
              hoverable: true,
              position : 'top left',
              delay: {
                show: 100,
                hide: 400
              }
            })
          ;
        }

        function drawRow(rowData, i) {
          var house = rowData.player.house[$('.ui.dropdown.league').dropdown("get value")]
            var row = $("<tr />")
            $("#leaderboard > tbody").append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
            html = ''
            html += '<td><h4 class="ui image header"><a class="ui large ' + colors[house]
            html += ' circular label" data-content="'+ rowData.player.full_name + '">'+ (parseInt(i)+1) +'</a></span><img style="display:none" src="https://graph.facebook.com/?type=large'
            html += rowData.player.facebook
            html += '/picture" alt="'+ rowData.player.full_name + '" class="ui mini rounded image"><div class="content">'
            html += rowData.player.alias
            html += '<div class="sub header">'
            html += house
            html += '</div></div></h4></td>'
            row.append($(html))
            for (var i = 0; i < rowData.scores.length; i++) {
                row.append($("<td>" + rowData.scores[i] + "</td>"));
            }
            row.append($('<td class="right aligned collapsing">'+rowData.score+'</td>'))
            
          }



       // LEAGUES

        var prop_loaded = false

        function populateLeaguesDropdown(games) {
            var leagues = Object.keys(games);
            var html = "";
            var current_league = 'random';
            for (var league in leagues) {
                var l = leagues[league]
                var str = '<div class="item" data-value=' + l + '><i class="university icon"></i>' + l + '</div>'
                html += str;
                current_league = l;
            }
            $('.leagues').append(html);
            
            if (leagues.length > 1){
              $('.optional').transition('drop');
            }

            $('.ui.dropdown.league').dropdown({
                action: 'activate',
                onChange: function(value, text, $selectedItem) {
                  if (prop_loaded == false){
                    prop_loaded = true;
                  } else {
                    loadChronicleEntries();
                  }
                }
            });
            $('.ui.dropdown.league').dropdown("set selected", current_league);
        }

        // EPISODES

        function populateEpisodeDropdown(episodes) {
            var html = "";
            var current_episode = "51";

            for (var ep in episodes) {
                if (episodes.hasOwnProperty(ep) && episodes[ep]['reported']) {
                    var episode = episodes[ep]
                    var str = '<div class="item" data-value=' + episode.number + '><i class="film icon"></i>6x' + episode.episode_number + ' ~ ' + episode.title + '</div>'
                    html += str;
                    if (episodes[ep]['current']) {
                        current_episode = episodes[ep]['number'];
                    }
                }
            }
            $('.episodes').append(html)

            $('.ui.dropdown.episode').dropdown({
                action: 'activate',
                onChange: function(value, text, $selectedItem) {
                  if (prop_loaded == false){
                    prop_loaded = true;
                  } else {
                    loadChronicleEntries();
                  }
                }
            });
            $('.ui.dropdown.episode').dropdown("set selected", current_episode)
            $('.ui.sticky.episodesx').sticky();
        }
        
        // VOTES

        var data_template = {
          "colorscale": [
              [0 , "rgb(233, 233, 233)"],
              [0.01 , "#B2E8C1"],
              [0.2 , "#FFFEC2"],
              [0.21 , "#FF8D7B"],
              [0.9 ,"#DC3C4D"],
              [1 ,"#CE0E2D"]
          ],
          "type": "heatmap",
          "showscale": false,
          "autocolorscale": false,
          "autobiny": true,
          "autobinx": true,
          "zauto": true,
      };

      var layout_template = {
          "hovermode": "x",
          "hoverinfo": "x+y",
          "font": {
              "color": "#444",
              "family": "\"Open sans\", verdana, arial, sans-serif",
              "size": 14
          },
          "autosize": true,
          "xaxis": {
              "autorange": true,
              "tickmode": "auto",
              "rangemode": "normal",
              "fixedrange": false
          },
          "bargroupgap": 0,
          "hidesources": true,
          "separators": ".,",
          "barmode": "group",
          "yaxis": {
              "autorange": 'reversed',
              "tickmode": "auto",
              "fixedrange": true
          },
          "height" : 1080,
          "width" : 920,
          "margin": {
              "b": 80,
              "l": 140,
              "r": 10,
              "pad": 10,
              "t": 0,
              "autoexpand": true
          }
      };

      function generateVoteDistribution(league, episode){
        getVoteDistribution(league, episode)
      }

      // GET Episode Votes

      function parseVoteDistribution(votes, data, layout){
        data['x'] = votes.houses
        data['y'] = votes.characters
        data['z'] = votes.values
  
        Plotly.newPlot('vote-distribution', [data], layout);
        $('.ui.sticky.episodesx').sticky('refresh');
      }

      function getVoteDistribution(league, episode){
        db.child('episode_votes')
          .child(league+episode)
          .once('value', function(snapshot){
            parseVoteDistribution(snapshot.val()['votes'], data_template, layout_template)
          })
        }

    // GET PLAYER VOTES 

    var award_colors = {
        "wit"  : 'purple',
        "damage"  : 'red',
        "jockey"  : 'orange',
        "style"  : 'blue',
        "support"  : 'green'
    }

    function votePanel(award, points, character, characters){
        html = '<div class="ui card '
        html += award_colors[award]
        html += ' inverted segment"><div class="image">'
        html += '<div class="image-holder image" style="background-image:url(\'assets/images/characters/'
        html += character
        html += '.jpg\')"></div></div><div class="content"><p class="header">'
        html += characters[character]['name']
        html += '</p></div><div class="extra content">'
        html += award.toUpperCase()
        html += '<div class="right floated author">'
        html += points
        html += ' points</div></div></div>'
        return html
    } 

    function parsePlayerVotes(votes, characters){
        var $ref = $('#voteCards')
        $ref.empty();
        for (var vote in votes) {
            if (votes.hasOwnProperty(vote) && vote.startsWith('vote')){
                var character = votes[vote];
                var v = vote.split('_')
                var html = votePanel(v[1],[0,20,8][v[2]],votes[vote], characters)
                $ref.append(html)
            }
        }
        $('.ui.sticky.episodesx').sticky('refresh');
    }

    function getPlayerVotes(league, episode){
        db.child('characters').once('value', function(snapshot){
            var characters = snapshot.val();
            for (var i = 0; i < authData.votes.length; i++) {
                db.child('votes')
                  .child(authData.votes[i])
                  .once('value', function(snapshot){
                    var votes = snapshot.val()
                    if (votes.league == league && votes.episode == episode){
                        $('#voteCardsPlaceholder').empty();
                        parsePlayerVotes(votes, characters)
                    } else {
                        return;
                    }
                  })
            }
        })
    }

    // GET PLAYER ROSTER 

    // var award_colors = {
    //     "wit"  : 'purple',
    //     "damage"  : 'red',
    //     "jockey"  : 'orange',
    //     "style"  : 'blue',
    //     "support"  : 'green'
    // }

    // function characterPanel(award, points, character, characters){
    //     html = '<div class="ui card '
    //     html += award_colors[award]
    //     html += ' inverted segment"><div class="image">'
    //     html += '<div class="image-holder image" style="background-image:url(\'assets/images/characters/'
    //     html += character
    //     html += '.jpg\')"></div></div><div class="content"><p class="header">'
    //     html += characters[character]['name']
    //     html += '</p></div><div class="extra content">'
    //     html += award.toUpperCase()
    //     html += '<div class="right floated author">'
    //     html += points
    //     html += ' points</div></div></div>'
    //     return html
    // } 

    // function parsePlayerRoster(votes, characters){
    //     var $ref = $('#playerRoster')
    //     $ref.empty();
    //     for (var vote in votes) {
    //         if (votes.hasOwnProperty(vote) && vote.startsWith('vote')){
    //             var character = votes[vote];
    //             var v = vote.split('_')
    //             var html = characterPanel(v[1],[0,20,8][v[2]],votes[vote], characters)
    //             $ref.append(html)
    //         }
    //     }
    //     $('.ui.sticky.episodesx').sticky('refresh');
    // }

    // function getPlayerRoster(league, episode){
    //     db.child('characters').once('value', function(snapshot){
    //         var characters = snapshot.val();
    //         for (var i = 0; i < authData.votes.length; i++) {
    //             db.child('votes')
    //               .child(authData.votes[i])
    //               .once('value', function(snapshot){
    //                 var votes = snapshot.val()
    //                 if (votes.league == league && votes.episode == episode){
    //                     $('#voteCardsPlaceholder').empty();
    //                     parsePlayerRoster(votes, characters)
    //                 } else {
    //                     return;
    //                 }
    //               })
    //         }
    //     })
    // }

     </script>
  </body>
</html>