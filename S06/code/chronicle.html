<!DOCTYPE html>
<html>
  <head>
    <title>Ascension | Crossed Banners ~ Chronicle</title>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
    <meta content='width=device-width, initial-scale=1' name='viewport'/>
  </head>
  <body>

  <style>

  .ui.form {
    font-size: 1rem;
    margin-bottom: 32px;
  }

  p {
    font-size: 1.2em;
    line-height: 1.6em;
    color: #555;
  }

  span.value,
  span.points,
  span.episode,
  span.power,
  span.house {
    color: black;
    font-weight: 500;
  }

  span.award,
  span.points {
    font-size: 1.5em;
    vertical-align: text-bottom;
    padding: 0 14px;
    display: inline-block;
  }

  span.episode {
    padding: 0 14px;
    display: inline-block;
    font-variant : small-caps;
    font-style: italic;
  }
  
  span.health,
  span.award,
  span.power {
    font-variant : titling-caps;
    color: rgba(19, 157, 255, 0.93)!important;
  }

  span.character,
  span.house {
    text-transform: uppercase;
    padding: 0 8px;
    display: inline-block;
  }

  span.pre {
    display: block;
    padding-bottom: 12px;
  }

  span.success {
    font-weight: bold;
    color: rgba(35, 224, 22, 0.93)!important
  }


  </style>

    <div class="ui hidden failed negative message">
      <i class="close icon"></i>
      <div class="header">
        We're sorry - Login failed for some reason.
      </div>
        <p>Please contact m@type.hk for support.</p>
      </div>
      <!-- Sidebar Menu -->
      <div class="ui inverted vertical sidebar menu">
        <a href="index.html" class="item">Game</a>
        <a href="rules.html" class="item">Rules</a>
        <a href="chronicle.html" class="active item">Chronicle</a>   
        <a href="characters.html" class="item">Characters</a>
      </div>
      <!-- Page Contents -->
      <div class="pusher">
        <div class="ui vertical masthead center aligned segment">
          <div class="ui container">
            <div class="ui large secondary pointing menu">
              <a class="toc item">
                <i class="sidebar icon"></i>
              </a>
              <a href="game.html" class="item">Game</a>
              <a href="rules.html" class="item">Rules</a>
              <a href="chronicle.html" class="active item">Chronicle</a>
              <a href="characters.html" class="item">Characters</a>
            </div>
          </div>
        </div>
        <div class="ui text container">
          <form onsubmit="return false;" class="ui form voting">
            <div class="ui">
              <h2 style="text-align: center;">CHRONICLE</h2>
            </div>
            
            <h3 class="ui horizontal pink divider header" style="overflow: visible;">
            <div class="ui inline dropdown episode">
              <div class="text">
                <i class="film icon"></i>
                6x01 ~ The Red Women
              </div>
              <i class="dropdown icon"></i>
              <div class="menu episodes"></div>
            </div>
            </h3>
            
            <h3 class="ui horizontal blue divider header optional" style="display: none; overflow: visible;">
            <div class="ui inline dropdown league">
              <div class="text">
                <i class="university icon"></i>
                Select League
              </div>
              <i class="dropdown icon"></i>
              <div class="menu leagues"></div>
            </div>
            </h3>

            <h4 class="ui horizontal divider header">
              <i class="columns icon"></i>
              Leaderboard
            </h4>

            <table id="leaderboard" class="ui very basic celled table left floated">
          </table>

            <h4 class="ui horizontal divider header">
            <i class="spy icon"></i>
            Private Announcements
            </h4>

           
            <h3 class="ui top attached inverted blue header sub header"><i class="newspaper icon"></i>
              Diplomatic Intelligence
            </h3>
            <div id="diplomatic">
              <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
       
            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Assassination Reports
            </h3>
            <div id="assassination">
              <div class="ui attached segment">
                  <div class="ui piled segments">
                    <div class="ui center aligned segment">
                      <p class="nonews">No news today</p>
                    </div> 
                  </div> 
                </div>
            </div>
            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Roster Damage 
            </h3>
            <div id="target">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            <h3 class="ui top attached inverted olive header sub header"><i class="newspaper icon"></i>
              House Abilities
            </h3>
            <div id="ability">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            
            <h3 class="ui top attached inverted blue header sub header"><i class="newspaper icon"></i>
              Effective Torture Methods
            </h3>
            <div id="foiled">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            
            <h3 class="ui top attached inverted olive header sub header"><i class="newspaper icon"></i>
              Award Performance
            </h3>
            <div id="awards">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
            <h3 class="ui top attached inverted olive header sub header"><i class="newspaper icon"></i>
              Rankings
            </h3>
            <div id="ranking">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>
    
            <h4 class="ui horizontal divider header">
              <i class="announcement icon"></i>
              Public Announcements
            </h4>

            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Failed Assassination Attempts
            </h3>
            <div id="failed">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>

            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Health Reports
            </h3>
            <div id="damage">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment large">
                    <p class="nonews ui large">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>

            <h3 class="ui top attached inverted red header sub header"><i class="newspaper icon"></i>
              Obituary
            </h3>
            <div id="death">
            <div class="ui attached segment">
                <div class="ui piled segments">
                  <div class="ui center aligned segment">
                    <p class="nonews">No news today</p>
                  </div> 
                </div> 
              </div>
            </div>           
            
            <h4 class="ui horizontal divider header">
              <i class="announcement icon"></i>
              Voting Histogram
            </h4>
            <div id="voterDistribution">
              
            </div>

                
          </div>
        </div>

        <script src="semantic/dist/semantic.min.js"></script>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        
        <script>
        var db = new Firebase("https://ascension.firebaseio.com");

        var authData = db.getAuth();

        // Reusable Sets

        var numerals = [0, 'I', 'II', 'III', 'IV', 'V']
        var colors = {
            'bolton': 'red',
            'meereen': 'brown',
            'arryn': 'blue',
            'greyjoy': 'black',
            'martell': 'orange',
            'independent': 'pink',
            'nightswatch': 'grey',
            'minor': 'olive',
            'targaryen': 'purple',
            'tyrell': 'green',
            'lannister': 'yellow',
            'stark': 'grey'
        }
        
        // Semantic ui
        $('.ui.sidebar').sidebar('attach events', '.toc.item');
        $('.ui.accordion').accordion();

        // // Update Mission Agents & Available Targets based on League Selection.

        // SET PLAYER 

        db.child('players').child(authData.uid).once('value', function(snapshot) {
            var player = snapshot.val();
            authData.house = player.house;
            populateLeaguesDropdown(player.games);
            // SET EPISODE 

            db.child('episodes').once('value', function(snapshot) {
                var episodes = snapshot.val();
                populateEpisodeDropdown(episodes);
            });
        });


        // DISPLAY Player Chronicle Entries
        function msgTemplate(){
          html = ''
          html += '<div class="ui attached segment"><div class="ui piled center aligned segments"><div class="ui center aligned segment"><p class="nonews">'
          html += 'No news today'
          html += '</p></div></div></div>'
          return html
        }
        
        function addArticle(category, msg){
          $ref = $('#' + category)
          if (!$ref.hasClass('populated')){
            $ref.empty();
            $ref.addClass('populated')
          }
          html = ''
          html += '<div class="ui attached segment"><div class="ui piled segments"><div class="ui center aligned segment"><p>'
          html += msg
          html += '</p></div></div></div>'
          $ref.append(html)
        }

        function parsePlayerChronicles(entries){
          for (var entry in entries) {
            var a = entries[entry]
            addArticle(a.cat,a.msg)
            }
          }
        
        // GET Player Chronicle Entries

        function getPlayerChronicles(playerKey){
          db.child('player_chronicles').orderByKey()
            .equalTo(playerKey)
            .once('value', function(snapshot){
              parsePlayerChronicles(snapshot.val()[playerKey]['entries'])
            })
        }

        // DISPLAY Player Chronicle Entries

        function parsePublicChronicles(entries){
          for (var entry in entries) {
            var a = entries[entry]
            addArticle(a.cat,a.msg)
            }
          }

        // GET Public Chronicle Entries

        function getPublicChronicles(leagueKey){
          db.child('league_chronicles').orderByKey()
            .equalTo(leagueKey)
            .once('value', function(snapshot){
              parsePublicChronicles(snapshot.val()[leagueKey]['entries'])
            })
        }

        // REFRESH Chroncles Entries
      
        function loadChronicleEntries(){
          var league = $('.ui.dropdown.league').dropdown("get value")
          var episode = $('.ui.dropdown.episode').dropdown("get value")
          var house = authData.house[league];

          $('.populated').empty()
          $('.populated').append(msgTemplate())
          $('.populated').removeClass('populated')

          getPlayerChronicles(league+house+episode);
          getPublicChronicles(league+episode);
          genetateLeaderboard(league, episode);

        }

        // DISPLAY Leaderboard
        
        var scoretable;

        function genetateLeaderboard(league, episode){
          scoretable = []
          var template = '<thead><tr><th>Player Rank</th></tr></thead><tbody></tbody>'
          $('#leaderboard').empty().html(template) 
          db.child('players').once('value', function(snapshot){
            getLeaderBoard(league+episode, league, episode, snapshot.val())
          });
        }

        

        // GET Leaderboard
        function parseLeaderBoard(scores, league, episode, players){

          for (var score in scores['scores']){
            scoretable.push(
                {'id': score,'player': players[score], 'score' : parseInt(scores['scores'][score]), 'scores' : []}
              )
          }
          getEpisodeScores(league, episode);
        }

        function getLeaderBoard(leaderboardKey, league, episode, players){
          db.child('leaderboard').orderByKey()
            .equalTo(leaderboardKey)
            .once('value', function(snapshot){
              parseLeaderBoard(snapshot.val()[leaderboardKey], league, episode, players)
            })
        }

        // GET EpisodeScores

        function parseEpisodeScores(scores){
          for (var score in scores){
            $('#leaderboard > thead > tr').append("<th>" + scores[score]['episode'] + "</th>")
            var escores = scores[score]['scores']
            for (var player in escores){
                for (var i = 0; i < scoretable.length; i++) {
                  if (scoretable[i].id == player){
                    scoretable[i]['scores'].push(parseInt(escores[player]))
                  }
                }
            }
          }
          scoretable.sort(function(a,b) {return b.score - a.score}); 

          drawTable(scoretable);
        }


        function getEpisodeScores(league, episode){
          db.child('episode_scores').orderByKey()
            .startAt(league)
            .endAt(league+episode)
            .once('value', function(snapshot){
              parseEpisodeScores(snapshot.val())
            })
        }


        function drawTable(data) {


            for (var i = 0; i < data.length; i++) {
                drawRow(data[i], i);
            }
            $('#leaderboard > thead > tr').append("<th>Total</th>")

            $('.circular.label')
            .popup({
              inline   : true,
              hoverable: true,
              position : 'top left',
              delay: {
                show: 100,
                hide: 400
              }
            })
          ;
        }

        function drawRow(rowData, i) {
          var house = rowData.player.house[$('.ui.dropdown.league').dropdown("get value")]
            var row = $("<tr />")
            $("#leaderboard > tbody").append(row); //this will append tr element to table... keep its reference for a while since we will add cels into it
            html = ''
            html += '<td><h4 class="ui image header"><a class="ui large ' + colors[house]
            html += ' circular label" data-content="'+ rowData.player.full_name + '">'+ (parseInt(i)+1) +'</a></span><img style="display:none" src="https://graph.facebook.com/?type=large'
            html += rowData.player.facebook
            html += '/picture" alt="'+ rowData.player.full_name + '" class="ui mini rounded image"><div class="content">'
            html += rowData.player.alias
            html += '<div class="sub header">'
            html += house
            html += '</div></div></h4></td>'
            row.append($(html))
            for (var i = 0; i < rowData.scores.length; i++) {
                row.append($("<td>" + rowData.scores[i] + "</td>"));
            }
            row.append($('<td class="right aligned collapsing">'+rowData.score+'</td>'))
            
          }



       // LEAGUES

        var prop_loaded = false

        function populateLeaguesDropdown(games) {
            var leagues = Object.keys(games);
            var html = "";
            var current_league = 'random';
            for (var league in leagues) {
                var l = leagues[league]
                var str = '<div class="item" data-value=' + l + '><i class="university icon"></i>' + l + '</div>'
                html += str;
                current_league = l;
            }
            $('.leagues').append(html);
            
            if (leagues.length > 1){
              $('.optional').transition('drop');
            }

            $('.ui.dropdown.league').dropdown({
                action: 'activate',
                onChange: function(value, text, $selectedItem) {
                  if (prop_loaded == false){
                    prop_loaded = true;
                  } else {
                    loadChronicleEntries();
                  }
                }
            });
            $('.ui.dropdown.league').dropdown("set selected", current_league);
        }

        // EPISODES

        function populateEpisodeDropdown(episodes) {
            var html = "";
            var current_episode = "51";

            for (var ep in episodes) {
                if (episodes.hasOwnProperty(ep) && episodes[ep]['reported']) {
                    var episode = episodes[ep]
                    var str = '<div class="item" data-value=' + episode.number + '><i class="film icon"></i>6x' + episode.episode_number + ' ~ ' + episode.title + '</div>'
                    html += str;
                    if (episodes[ep]['current']) {
                        current_episode = episodes[ep]['number'];
                    }
                }
            }
            $('.episodes').append(html)

            $('.ui.dropdown.episode').dropdown({
                action: 'activate',
                onChange: function(value, text, $selectedItem) {
                  if (prop_loaded == false){
                    prop_loaded = true;
                  } else {
                    loadChronicleEntries();
                  }
                }
            });
            $('.ui.dropdown.episode').dropdown("set selected", current_episode)
        }
        
       
        // Form Submission

        $('.ui.button.submit').click(function(e){

          $('.message.error').hide();

          if (!$('form.voting').form('is valid') ) {
              $('.message.error').transition('drop').text('Please vote for both winner & runner up in all categories');
              return false;
            }

          if (!$('form.missions').form('is valid') ) {
              $('.message.error').transition('drop').text('You can\'t send the same character on both missions.');
              return false;
            }

          var votes = parseVotes();
          var missions = parseMissions();


          // Push Votes
          var votesListRef = new Firebase("https://ascension.firebaseio.com/votes");
          var newVoteRef = votesListRef.push();
          newVoteRef.set(votes)
          
          var path = newVoteRef.toString();
          var pathelem = path.split('/');
          var voteskey = pathelem[pathelem.length-1];

          // Update User Details

          var payload = {};
          
          payload[voteskey] = true;

          db.child('players').child(authData.uid).child('votes').update(payload, function(error) {
            if (error) {
              $('.message').text(error).transition('drop');
              console.log('Submission Failed!');
            } else {

              // Push Missions
                var missionListRef = new Firebase("https://ascension.firebaseio.com/missions");
                var newMissionRef = missionListRef.push();
                newMissionRef.set(missions);
                
                var path = newMissionRef.toString();
                var pathelem = path.split('/');
                var missionkey = pathelem[pathelem.length-1];

                // Update User Details

                var payload = {};
                
                payload[missionkey] = true;

                db.child('players').child(authData.uid).child('missions').update(payload, function(error) {
                  if (error) {
                    $('.message').text(error).transition('drop');
                    console.log('Submission Failed! On Mission, Votes Were Submitted');
                  } else {
                    window.location.href = 'thanks.html';
                  }
                });
            };
          });
        });

        // Plot.ly

        var data = [{
          "textfont": {},
          "zmax": 70,
          "uid": "19b265",
          "colorscale": [
              [0, "rgb(12,51,131)"],
              [0.25, "rgb(10,136,186)"],
              [0.5, "rgb(242,211,56)"],
              [0.75, "rgb(242,143,56)"],
              [1, "rgb(217,30,30)"]
          ],
          "type": "heatmap",
          "zmin": 50.2,
          "error_x": {},
          "name": "cimar:199:c76973",
          "colorbar": {},
          "contours": {
              "start": 52,
              "end": 68.02,
              "size": 2
          },
          "y": ["Agnostic male", "Atheist male", "Buddhist male", "Catholic male", "Protestant male", "Hindu male", "Muslim male", "Jewish male"],
          "x": ["Agnostic female", "Atheist female", "Buddhist female", "Catholic female", "Protestant female", "Hindu female", "Muslim female", "Jewish female"],
          "z": [
              ["69", "69", "65", "61", "59", "61", "53", "68"],
              ["70", "70", "65", "60", "57", "65", "52", "68"],
              ["66", "66", "64", "59", "57", "59", "57", "66"],
              ["61", "59", "59", "61", "61", "61", "57", "62"],
              ["59", "56", "57", "61", "61", "59", "57", "60"],
              ["56", "57", "55", "57", "55", "52", "54", "55"],
              ["49", "47", "49", "53", "53", "53", "59", "48"],
              ["68", "68", "64", "61", "60", "62", "60", "68"]
          ],
          "autobiny": true,
          "autobinx": true,
          "zauto": false,
          "error_y": {}
      }];
var layout = {
    "boxmode": "overlay",
    "paper_bgcolor": "rgb(243, 243, 243)",
    // "height": 828,
    "titlefont": {
        "color": "",
        "family": "",
        "size": 0
    },
    "hovermode": "x",
    "font": {
        "color": "#444",
        "family": "\"Open sans\", verdana, arial, sans-serif",
        "size": 12
    },
    "autosize": true,
    "title": "OKCupid Compatibility by Religion<br>Source: <a href=\"http://blog.okcupid.com/index.php/how-races-and-religions-match-in-online-dating/\">OKTrends, 2009</a>",
    "plot_bgcolor": "rgb(243, 243, 243)",
    "dragmode": "zoom",
    "smith": false,
    // "width": 1620,
    "bargap": 0.2,
    "xaxis": {
        "domain": [0, 1],
        "showticklabels": true,
        "showexponent": "all",
        "gridcolor": "#eee",
        "linecolor": "#444",
        "mirror": false,
        "nticks": 0,
        "linewidth": 1,
        "autorange": false,
        "zerolinecolor": "#444",
        "tickmode": "auto",
        "title": "Click to enter X axis title",
        "ticks": "outside",
        "showgrid": true,
        "overlaying": false,
        "zeroline": true,
        "type": "category",
        "zerolinewidth": 1,
        "ticklen": 5,
        "titlefont": {
            "color": "",
            "family": "",
            "size": 0
        },
        "tickcolor": "#444",
        "showline": false,
        "tickfont": {
            "color": "",
            "family": "",
            "size": 0
        },
        "tickwidth": 1,
        "tick0": 0,
        "tickangle": "auto",
        "gridwidth": 1,
        "dtick": 1,
        "rangemode": "normal",
        "range": [7.538343222398247, -0.5430458409141963],
        "position": 0,
        "anchor": "y",
        "exponentformat": "B"
    },
    "bargroupgap": 0,
    "hidesources": false,
    "showlegend": false,
    "separators": ".,",
    "barmode": "group",
    "boxgap": 0.3,
    "legend": {
        "bordercolor": "#444",
        "bgcolor": "#fff",
        "font": {
            "color": "",
            "family": "",
            "size": 0
        },
        "borderwidth": 0,
        "traceorder": "normal"
    },
    "yaxis": {
        "domain": [0, 1],
        "showticklabels": true,
        "showexponent": "all",
        "gridcolor": "#eee",
        "linecolor": "#444",
        "mirror": false,
        "nticks": 0,
        "linewidth": 1,
        "autorange": false,
        "zerolinecolor": "#444",
        "tickmode": "auto",
        "title": "Click to enter Y axis title",
        "ticks": "outside",
        "showgrid": true,
        "overlaying": false,
        "zeroline": true,
        "type": "category",
        "zerolinewidth": 1,
        "ticklen": 5,
        "titlefont": {
            "color": "",
            "family": "",
            "size": 0
        },
        "tickcolor": "#444",
        "showline": false,
        "tickfont": {
            "color": "",
            "family": "",
            "size": 0
        },
        "tickwidth": 1,
        "tick0": 0,
        "tickangle": "auto",
        "gridwidth": 1,
        "dtick": 1,
        "side": "left",
        "rangemode": "normal",
        "range": [7.6288092308495346, -0.556818666449125],
        "position": 0,
        "anchor": "x",
        "exponentformat": "B"
    },
    "boxgroupgap": 0.3,
    "margin": {
        "b": 80,
        "l": 100,
        "r": 80,
        "pad": 0,
        "t": 100,
        "autoexpand": true
    }
};
  Plotly.plot('voterDistribution', data, layout);
         </script>
      </body>
    </html>