<!DOCTYPE html>
<html>
<head>
    <title>Ascension | Crossed Banners</title>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">



</head>
<body class="pushable">

<!-- Sidebar Menu -->
    <div class="ui inverted vertical sidebar menu">
      <a href="http://tijptjik.github.io/ascension/S06/code/" class="active item">Home</a>
      <a href="rules.html" class="item">Rules</a>
      <a href="characters.html" class="item">Characters</a>
    </div>
    <!-- Page Contents -->
    <div class="pusher">
      <div class="ui vertical masthead center aligned segment">
        <div class="ui container">
          <div class="ui large secondary pointing menu">
            <a class="toc item">
              <i class="sidebar icon"></i>
            </a>
            <a href="http://tijptjik.github.io/ascension/S06/code/" class="active item">Home</a>
            <a href="rules.html" class="item">Rules</a>
            <a href="characters.html" class="item">Characters</a>
          </div>
        </div>
      </div>

<div class="ui text container">
    <form onsubmit="return false;" class="ui form huge">
        <div class="ui">
            <h2 style="text-align: center;">JOIN THE GAME</h2>
        </div>
    <h4 class="ui horizontal divider header">
      <i class="bar university icon"></i>
      Personal Details
    </h4>
      <div class="field">
        <label>Full Name</label>
        <input placeholder="e.g. Mart van de Ven" name="name" type="text">
      </div>
      <div class="field">
        <label>E-mail Address</label>
        <input placeholder="e.g. m@type.hk" name="email" type="text">
      </div>
      <div class="field">
        <label>Game of Thrones Alias</label>
        <input placeholder="e.g. Ser Killsalot" name="alias" type="text">
      </div>
      <div class="field">
        <label>League - Assigned by the Game Master</label>
        <select class="ui dropdown league" name="league">
          <option value="random">Random</option>
        </select>
        <div class="ui accordion field">
          <div class="title">
            <i class="icon dropdown"></i>
            HELP : I wasn't assigned a League!?
          </div>
          <div class="content field">
            <p>Join the <i>Random</i> League and the game will sort you out!</p>
          </div>
        </div>
      <div class="field">
        <label>House - Assigned by the Game Master</label>
        <select class="ui dropdown" name="house">
          <option value="">Select</option>
        </select>
        <div class="ui accordion field">
          <div class="title">
            <i class="icon dropdown"></i>
            HELP : I wasn't assigned a House!?
          </div>
          <div class="content field">
            <p>Please get in touch with <a href="mailto:m@type.hk">Game Master</a> for assistance</p>
          </div>
        </div>
      </div>
      <h4 class="ui horizontal divider header">
          <i class="bar diamond icon"></i>
          Drafting Characters
        </h4>
        Characters are listed with their house colour and name. Between brackets you'll find their Prominence, Violence and Diplomacy powers.
        <div class="ui accordion field">
          <div class="title">
            <i class="icon dropdown"></i>
            HELP : How do I select my characters?
          </div>
          <div class="content field">
            <div class="ui celled ordered list">
              <div class="item">Pick characters which excell at being <a target="_blank" href="https://github.com/tijptjik/ascension/blob/gh-pages/S06/rules.md#award-categories">violent, witty, cunning, supportive or stylish</a>.</div>
              <div class="item">Consider their <a target="_blank" href="https://github.com/tijptjik/ascension/blob/gh-pages/S06/rules.md#prominence-multiplier">Prominence</a> - the roman numeral behind their name - Greater prominence makes it harder for them to score points.</div>
              <div class="item">Pick at least some characters with strong Violence and Diplomany Powers - See <a target="_blank" href="https://github.com/tijptjik/ascension/blob/gh-pages/S06/character.powers.csv">Character Powers</a> for a full list</div>
              <div class="item">Avoid obvious choices - they will get killed.</div>
            </div>
          </div>
          <div class="title">
            <i class="icon dropdown"></i>
            HELP : What do the character colours mean?
          </div>
          <div class="content field">
            <div class="ui divided aligned list housecolours"></div>
          </div>
        </div>
      <div class="field">
        <label>Slot I</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char1">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
          </div>
      </div>
      <div class="field">
        <label>Slot II</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char2">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
        </div>
      </div>
        <div class="field">
        <label>Slot III</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char3">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
          </div>
      </div>
      <div class="field">
        <label>Slot IV</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char4">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
        </div>
      </div>
      <div class="field">
        <label>Slot V</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char5">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
        </div>
      </div>
      <div class="field">
        <label>Slot VI</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char6">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
        </div>
      </div>
      <div class="field">
        <label>Slot VII</label>
        <div class="ui fluid search selection dropdown">
          <input type="hidden" name="char7">
          <i class="dropdown icon"></i>
          <div class="default text">Select Character</div>
          <div class="menu characters">
          </div>
        </div>
      </div>
      <br>
      <div class="fluid ui button submit inverted huge blue center">Submit</div>
      <div class="ui error message"></div>
    </form>
    <br>
    <br>
    <br>

</div>
</div>
<script src="semantic/dist/semantic.min.js"></script>

<script>
var userData = {};
var db = new Firebase("https://ascension.firebaseio.com");

var USER_TEMPLATE = {
        "full_name" : "",
        "first_name" : "",
        "alias" : "",
        "alias_short" : "",
        "email": "",
        "facebook" : "",
        "games": true
    }

var is_player = function(authData){
  if (authData){
    db.child('players')
      .child(authData.uid)
      .once('value', function(snapshot){
        // if data exists
        var fb = authData.facebook;
        if (snapshot.exists()) {
            // get the ref (in this case /users/2) and update its contents
            userData = authData;
            $('form').form('set value', 'name', fb.displayName)
            $('form').form('set value', 'email', fb.email)
        } else {
            console.log('new')
            // data does not exist so we wrap the data in an object with
            // a member named after the uid so we can pass it as an update
            // to the parent.
            
            var payload = {};
                user = USER_TEMPLATE;
                user['full_name'] = fb.displayName;
                user['email'] = fb.email;
                user['facebook'] = fb.id;
                try{
                    user['first_name'] = fb.cachedUserProfile.first_name;
                }
                catch(e){
                    user['first_name'] = 'Anon';    
                }

                payload[authData.uid] = user;
              
              $('form').form('set value', 'name', fb.displayName)
              $('form').form('set value', 'email', fb.email)

            // get the ref's parent and call update on it.

            snapshot.ref().parent().update(payload);
        }
    });
    } else {
      window.location.href = 'index.html';
    }
}


// Register the callback to be fired every time auth state changes
db.onAuth(is_player);

function populateCharacterDropdowns(chars){
  var numerals = [0,'I','II','III','IV','V']
  var colors = {
    'bolton' : 'red',
    'meereen' : 'brown',
    'arryn' : 'blue',
    'greyjoy' : 'black',
    'martell' : 'orange',
    'independent' : 'pink',
    'nightswatch' : 'grey',
    'minor' : 'olive',
    'targaryen' : 'purple',
    'tyrell' : 'green',
    'lannister' : 'yellow',
    'stark' : 'grey'
  }

  function toTitleCase(str){
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
  }

  db.child('leagues').once('value',function(snapshot){
    var leagues = Object.keys(snapshot.val());
    for (var league in leagues) {
          $('select[name="league"]').append('<option value="'+leagues[league]+'">'+ toTitleCase(leagues[league]) + ' League</option>');
        }
    });

  db.child('houses').once('value',function(snapshot){
    var houses = snapshot.val();
    for (var house in colors) {
        if (colors.hasOwnProperty(house)) {
          var html = '<div class="item huge"><i class="ui '+colors[house]+' certificate large icon"></i><div class="content huge" style="vertical-align: middle;">'+houses[house].name+'</div>'
          $('.housecolours').append(html);
          $('select[name="house"]').append('<option value="'+house+'">'+houses[house].name+'</option>');
        }
    }
  })

  

  var html = "";
  for (var character in chars) {
    if (chars.hasOwnProperty(character)) {
      var char = chars[character]
      var str = '<div class="item huge" data-value="'+char.id+'"><div class="ui '+colors[char.house]+' empty circular label"></div>'+char.name+ ' ('+numerals[char.prominence] +'-'+char.violence+'/'+char.diplomacy+')</div>'
      html += str;
    }
  }
  $('.menu.characters').append(html);

  $('.ui.dropdown')
      .dropdown({ fullTextSearch: true })
    ;
}

db.child('characters').once('value', function(snapshot){
  var characters = snapshot.val();
  populateCharacterDropdowns(characters);
});



// Semantic UI

$(document)
    .ready(function() {

      $('.message .close')
        .on('click', function() {
          $(this)
            .closest('.message')
            .transition('fade')
          ;
        })
      ;

      // create sidebar and attach to menu open
      $('.ui.sidebar')
        .sidebar('attach events', '.toc.item');

      $('.ui.accordion').accordion();

      $('.ui.form')
        .form({
          fields: {
            name: {
              identifier: 'name',
              rules: [
                {
                  type   : 'empty',
                  prompt : 'Please enter your full name'
                }
              ]
            },
          alias: {
              identifier: 'alias',
              rules: [
                {
                  type   : 'empty',
                  prompt : 'Please enter your Player Name'
                }
              ]
            },
            email: {
              identifier: 'email',
              rules: [
                {
                  type   : 'email',
                  prompt : 'Please enter your email'
                }
              ]
            },
            league: {
              identifier: 'league',
              rules: [
                {
                  type   : 'empty',
                  prompt : 'Please indicate your League'
                }
              ]
            },
            house: {
              identifier: 'house',
              rules: [
                {
                  type   : 'empty',
                  prompt : 'Please indicate your House'
                }
              ]
            },
            char1: {
              identifier: 'char1',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char2]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char3]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char4]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char5]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char6]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char7]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            },
          char2: {
              identifier: 'char2',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char1]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char3]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char4]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char5]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char6]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char7]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            },
          char3: {
              identifier: 'char3',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char2]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char1]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char4]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char5]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char6]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char7]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            },
                  char4: {
              identifier: 'char4',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char2]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char3]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char1]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char5]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char6]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char7]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            },
                  char5: {
              identifier: 'char5',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char2]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char3]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char4]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char1]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char6]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char7]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            },
                  char6: {
              identifier: 'char6',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char2]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char3]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char4]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char5]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char1]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char7]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            },
                  char7: {
              identifier: 'char7',
              rules: [
                {
                  type : 'empty',
                  prompt : 'You haven\'t selected all 7 characters.'
                },
                {
                  type   : 'different[char2]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char3]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char4]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char5]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char6]',
                  prompt : 'You cant select the same character twice'
                },
                {
                  type   : 'different[char1]',
                  prompt : 'You cant select the same character twice'
                },
              ]
            }
          }
        })
      ;



  $('.ui.button.submit').click(function(e){
      var roster = $('form').form('get values');
      var house = roster.house;
      
      $.each(roster, function(key, value) {
        if(key.indexOf('char') == -1) {
            delete roster[key];
        }
      });

      // Push Roster
      var rosterListRef = new Firebase("https://ascension.firebaseio.com/rosters");
      var newRosterRef = rosterListRef.push();
      newRosterRef.set(roster)
      
      var path = newRosterRef.toString();
      var pathelem = path.split('/');
      var rosterkey = pathelem[pathelem.length-1];

      var roster = $('form').form('get values');
      var payload = {};

      var league_houses = {};
      league_houses[roster.house] = true

      // Update User Details

      payload['games/' + roster.league] = rosterkey;
      payload['house/' + roster.league] = roster.house;
      payload['full_name'] = roster.name;
      payload['email'] = roster.email;
      payload['alias'] = roster.alias;

      db.child('league_houses').child(roster.league).update(league_houses, function(error) {
          if (error) {
              $('.message').text(error).transition('drop');
              console.log('Submission Failed!');
            } else {
              db.child('players').child(userData.uid).update(payload, function(error) {
                      if (error) {
                        $('.message').text(error).transition('drop');
                        console.log('Submission Failed!');
                      } else {
                        window.location.href = 'game.html';
                      }
                    }
                )
            }
          }
      )
  });

});
</script>
</body>
</html>